image: docker:24.0-cli

stages:
  - build
  - deploy

variables:
  IMAGE_TAG_BE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
  WORKDIR: /home/deployer/app/ontoolaz

before_script:
  - apk add --no-cache curl
  - echo "$CI_JOB_TOKEN" | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  - mkdir -p ~/.ssh
  - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts

build_be:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      changes: [backend/**/*]
    - if: '$CI_COMMIT_BRANCH == "master" && $FORCE_DEPLOY_BE == "true"'
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes: [backend/**/*]
  script:
    - docker build -t $IMAGE_TAG_BE ./backend
    - docker push $IMAGE_TAG_BE

deploy_be_dev:
  stage: deploy
  needs: [build_be]
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      changes: [backend/**/*]
  environment:
    name: dev
  script:
    - |
      ssh $SSH_USER@$SSH_HOST "
        cd $WORKDIR/backend &&
        export IMAGE_TAG=$CI_COMMIT_SHORT_SHA &&
        export NODE_ENV=development &&
        docker compose pull &&
        docker compose down &&
        docker compose up -d
      "
      sh $CI_PROJECT_DIR/send_telegram.sh "[BE - DEV] ‚úÖ DEPLOYED" "..."

deploy_be_prod:
  stage: deploy
  needs: [build_be]
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $FORCE_DEPLOY_BE == "true"'
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes: [backend/**/*]
  environment:
    name: production
  script:
    - |
      ssh $SSH_USER@$SSH_HOST "
        echo $DEPLOY_REGISTRY_PASSWORD | docker login -u $DEPLOY_REGISTRY_USER --password-stdin registry.gitlab.com &&
        cd $WORKDIR/backend &&
        export IMAGE_TAG=$CI_COMMIT_SHORT_SHA &&
        export NODE_ENV=production &&
        docker compose pull &&
        docker compose down &&
        docker compose up -d
      "
      sh $CI_PROJECT_DIR/send_telegram.sh "[BE - PROD] ‚úÖ DEPLOYED" "Image: \`$IMAGE_TAG_BE\`%0ABranch: \`$CI_COMMIT_REF_NAME\`%0ACommit: \`$CI_COMMIT_SHORT_SHA\`%0ABy: \`$GITLAB_USER_NAME\`%0ATime: \`$(date -u '+%Y-%m-%d %H:%M UTC')\`"

  after_script:
    - |
      if [ "$CI_JOB_STATUS" != "success" ]; then
        sh $CI_PROJECT_DIR/send_telegram.sh "[BE - PROD] ‚ùå FAILED" "Job: \`$CI_JOB_NAME\`%0AStatus: \`$CI_JOB_STATUS\`%0ABranch: \`$CI_COMMIT_REF_NAME\`%0ACommit: \`$CI_COMMIT_SHORT_SHA\`%0ABy: \`$GITLAB_USER_NAME\`"
      fi

redeploy_be_prod_manual:
  stage: deploy
  when: manual
  environment:
    name: production
  script:
    - echo "üîß B·∫Øt ƒë·∫ßu build BE"
    - docker build -t $IMAGE_TAG_BE ./backend
    - docker push $IMAGE_TAG_BE

    - echo "üöÄ Deploy BE l√™n production"
    - |
      ssh $SSH_USER@$SSH_HOST "
        echo $DEPLOY_REGISTRY_PASSWORD | docker login -u $DEPLOY_REGISTRY_USER --password-stdin registry.gitlab.com &&
        cd $WORKDIR/backend &&
        export IMAGE_TAG=$CI_COMMIT_SHORT_SHA &&
        export NODE_ENV=production &&
        docker compose pull &&
        docker compose down &&
        docker compose up -d
      "

    - echo "üì£ G·ª≠i th√¥ng b√°o Telegram"
    - |
      sh $CI_PROJECT_DIR/send_telegram.sh "[BE - PROD] üîÅ REDEPLOYED" "Image: \`$IMAGE_TAG_BE\`%0ABranch: \`$CI_COMMIT_REF_NAME\`%0ACommit: \`$CI_COMMIT_SHORT_SHA\`%0ABy: \`$GITLAB_USER_NAME\`%0ATime: \`$(date -u '+%Y-%m-%d %H:%M UTC')\`"

rollback_be_prod:
  stage: deploy
  when: manual
  environment:
    name: production
  variables:
    ROLLBACK_TAG: "" # B·∫°n truy·ªÅn gi√° tr·ªã n√†y khi run job th·ªß c√¥ng
  script:
    - |
      if [ -z "$ROLLBACK_TAG" ]; then
        echo "‚ùå ROLLBACK_TAG is required. Example: dev-abc123"
        exit 1
      fi
      echo "üöÄ Rolling back to tag: $ROLLBACK_TAG"

      ssh $SSH_USER@$SSH_HOST "
        echo $DEPLOY_REGISTRY_PASSWORD | docker login -u $DEPLOY_REGISTRY_USER --password-stdin registry.gitlab.com &&
        cd $WORKDIR/backend &&
        export IMAGE_TAG=$ROLLBACK_TAG &&
        export NODE_ENV=production &&
        docker compose pull &&
        docker compose down &&
        docker compose up -d
      "

      sh $CI_PROJECT_DIR/send_telegram.sh "[BE - PROD] ‚ôªÔ∏è ROLLBACKED" "Tag: \`$ROLLBACK_TAG\`%0ABy: \`$GITLAB_USER_NAME\`"
